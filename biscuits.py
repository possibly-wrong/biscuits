import numpy as np
from math import factorial
from itertools import combinations, product, islice
from functools import cache
from fractions import Fraction

def multinomial(r):
    """Multinomial coefficient {sum(r) \choose {r[0], r[1], ...}}."""
    return factorial(sum(r)) // np.prod([factorial(k) for k in r], dtype=object)

def rolls(n, d):
    """List distinct rolls of n d-sided dice."""
    return [np.diff(roll, prepend=0, append=n + d) - 1
            for roll in combinations(range(1, n + d), d - 1)]

@cache
def score(ns, ds):
    """Expected additional score from rolling ns[:] dice with ds[:] sides."""
    return sum(Fraction(np.prod([multinomial(r) for r in roll], dtype=object)) *
               max(scores(roll, ns, ds), default=0)
               for roll in product(*(rolls(n, d)
                                     for n, d in zip(ns, ds)))
               ) / np.prod(np.array(ds, dtype=object) ** ns)

def scores(roll, ns, ds, include_moves=False):
    """Generate scores [and moves] from keeping subsets of rolled dice."""

    # islice(moves, 1, None) skips the first all-zero move, enforcing keeping
    # at least one die.
    for keep in islice(product(*(product(*(range(count + 1) for count in die))
                                 for die in roll)), 1, None):
        kept = sum(np.array(die, dtype=object).dot(range(1, d + 1))
                   for d, die in zip(ds, keep))
        rolled = score(tuple(n - sum(die) for n, die in zip(ns, keep)), ds)
        yield (kept + rolled, keep) if include_moves else (kept + rolled)

def analyze(roll):
    """Print all possible moves from a given roll, sorted by E(score).

    For example, rolling all d6=6, and d8=d10=d12=1:
    ```
    analyze(((0, 0, 0, 0, 0, 12),
             (1, 0, 0, 0, 0, 0, 0, 0),
             (1, 0, 0, 0, 0, 0, 0, 0, 0, 0),
             (1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)))
    ```
    """
    ns = tuple(sum(die) for die in roll)
    ds = tuple(len(die) for die in roll)
    for value, keep in sorted(scores(roll, ns, ds,
                                     include_moves=True), reverse=True):
        print(f'{value:7.3f} points by keeping ', end='')
        for d, die in zip(ds, keep):
            if sum(die) > 0:
                print(f'd{d} (', end='')
                for pips, count in enumerate(die):
                    for _ in range(count):
                        print(f'{pips+1} ', end='')
                print('), ', end='')
        print()
                
if __name__ == '__main__':

    # Use pre-computed values.
    def score(ns, ds):
        return cached[(ns, ds)]
    
    cached = {
        ((0, 0, 0, 0), (6, 8, 10, 12)): Fraction(0),
        ((0, 0, 0, 1), (6, 8, 10, 12)): Fraction(13, 2),
        ((0, 0, 1, 0), (6, 8, 10, 12)): Fraction(11, 2),
        ((0, 0, 1, 1), (6, 8, 10, 12)): Fraction(343, 24),
        ((0, 1, 0, 0), (6, 8, 10, 12)): Fraction(9, 2),
        ((0, 1, 0, 1), (6, 8, 10, 12)): Fraction(629, 48),
        ((0, 1, 1, 0), (6, 8, 10, 12)): Fraction(95, 8),
        ((0, 1, 1, 1), (6, 8, 10, 12)): Fraction(109819, 5120),
        ((1, 0, 0, 0), (6, 8, 10, 12)): Fraction(7, 2),
        ((1, 0, 0, 1), (6, 8, 10, 12)): Fraction(859, 72),
        ((1, 0, 1, 0), (6, 8, 10, 12)): Fraction(1283, 120),
        ((1, 0, 1, 1), (6, 8, 10, 12)): Fraction(435601, 21600),
        ((1, 1, 0, 0), (6, 8, 10, 12)): Fraction(227, 24),
        ((1, 1, 0, 1), (6, 8, 10, 12)): Fraction(780725, 41472),
        ((1, 1, 1, 0), (6, 8, 10, 12)): Fraction(1005739, 57600),
        ((1, 1, 1, 1), (6, 8, 10, 12)): Fraction(65517065383, 2388787200),
        ((2, 0, 0, 0), (6, 8, 10, 12)): Fraction(593, 72),
        ((2, 0, 0, 1), (6, 8, 10, 12)): Fraction(272251, 15552),
        ((2, 0, 1, 0), (6, 8, 10, 12)): Fraction(139409, 8640),
        ((2, 0, 1, 1), (6, 8, 10, 12)): Fraction(8746314017, 335923200),
        ((2, 1, 0, 0), (6, 8, 10, 12)): Fraction(19141, 1296),
        ((2, 1, 0, 1), (6, 8, 10, 12)): Fraction(10579060855, 429981696),
        ((2, 1, 1, 0), (6, 8, 10, 12)): Fraction(34567765537, 1492992000),
        ((2, 1, 1, 1), (6, 8, 10, 12)): Fraction(62054181548192611, 1857520926720000),
        ((3, 0, 0, 0), (6, 8, 10, 12)): Fraction(13049, 972),
        ((3, 0, 0, 1), (6, 8, 10, 12)): Fraction(934681337, 40310784),
        ((3, 0, 1, 0), (6, 8, 10, 12)): Fraction(9125623, 419904),
        ((3, 0, 1, 1), (6, 8, 10, 12)): Fraction(417213331375699, 13060694016000),
        ((3, 1, 0, 0), (6, 8, 10, 12)): Fraction(15142237, 746496),
        ((3, 1, 0, 1), (6, 8, 10, 12)): Fraction(814420779871715, 26748301344768),
        ((3, 1, 1, 0), (6, 8, 10, 12)): Fraction(6718154600039453, 232190115840000),
        ((3, 1, 1, 1), (6, 8, 10, 12)): Fraction(22767993480837938986957, 577763309046988800000),
        ((4, 0, 0, 0), (6, 8, 10, 12)): Fraction(989065, 52488),
        ((4, 0, 0, 1), (6, 8, 10, 12)): Fraction(9079408284187, 313456656384),
        ((4, 0, 1, 0), (6, 8, 10, 12)): Fraction(186709760083, 6802444800),
        ((4, 0, 1, 1), (6, 8, 10, 12)): Fraction(230874633146246613181, 6093597400104960000),
        ((4, 1, 0, 0), (6, 8, 10, 12)): Fraction(1806965057171, 69657034752),
        ((4, 1, 0, 1), (6, 8, 10, 12)): Fraction(60478991933640173869, 1663958330055327744),
        ((4, 1, 1, 0), (6, 8, 10, 12)): Fraction(50245985357761034711, 1444408272617472000),
        ((4, 1, 1, 1), (6, 8, 10, 12)): Fraction(440825025223564130947645560629, 9704204980882671403008000000),
        ((5, 0, 0, 0), (6, 8, 10, 12)): Fraction(1108166095, 45349632),
        ((5, 0, 0, 1), (6, 8, 10, 12)): Fraction(84858161756664679, 2437438960041984),
        ((5, 0, 1, 0), (6, 8, 10, 12)): Fraction(8794248228237701, 264479053824000),
        ((5, 0, 1, 1), (6, 8, 10, 12)): Fraction(49881165763186808775564743, 1137211521197188055040000),
        ((5, 1, 0, 0), (6, 8, 10, 12)): Fraction(2543789561891671, 80244904034304),
        ((5, 1, 0, 1), (6, 8, 10, 12)): Fraction(157589276297956021134621533, 3726414712658945818755072),
        ((5, 1, 1, 0), (6, 8, 10, 12)): Fraction(109693122989488674677590903, 2695612494689630945280000),
        ((5, 1, 1, 1), (6, 8, 10, 12)): Fraction(1118384863355019427677712312326304841, 21732450604226972014979579904000000),
        ((6, 0, 0, 0), (6, 8, 10, 12)): Fraction(332273594663, 11019960576),
        ((6, 0, 0, 1), (6, 8, 10, 12)): Fraction(18521544997519584522553, 454884608478875222016),
        ((6, 0, 1, 0), (6, 8, 10, 12)): Fraction(482709462328289466271, 12339534735212544000),
        ((6, 0, 1, 1), (6, 8, 10, 12)): Fraction(158722859648446657561215062364361, 3183464443978560353756774400000),
        ((6, 1, 0, 0), (6, 8, 10, 12)): Fraction(1264772825546407254503, 33695156183620386816),
        ((6, 1, 0, 1), (6, 8, 10, 12)): Fraction(402764937921132388233842625588967, 8345261032023157253752158683136),
        ((6, 1, 1, 0), (6, 8, 10, 12)): Fraction(140763083723205440163766633923059, 3018395917253746113191608320000),
        ((6, 1, 1, 1), (6, 8, 10, 12)): Fraction(167936299438213299123294961329782929221845639, 2920173740325543186232955366402949120000000),
        ((7, 0, 0, 0), (6, 8, 10, 12)): Fraction(4621176159903031, 128536820158464),
        ((7, 0, 0, 1), (6, 8, 10, 12)): Fraction(7921478880657735611765768527, 169784770345523218867027968),
        ((7, 0, 1, 0), (6, 8, 10, 12)): Fraction(15553988139272983175110979, 345427999563645871718400),
        ((7, 0, 1, 1), (6, 8, 10, 12)): Fraction(2987335272287089731089045334366717537791, 53469978155374936271355383906304000000),
        ((7, 1, 0, 0), (6, 8, 10, 12)): Fraction(3276723987891170787058480445, 75459897931343652829790208),
        ((7, 1, 0, 1), (6, 8, 10, 12)): Fraction(3041908691656227515005368337881825659437, 56067335814250429175672743034936623104),
        ((7, 1, 1, 0), (6, 8, 10, 12)): Fraction(10667471111644073132295792128117835719369, 202789843078162721266177456000204800000),
        ((7, 1, 1, 1), (6, 8, 10, 12)): Fraction(149649530406335309996876825835856044265591973428532323, 2354289857774701221258168749134202778786201600000000),
        ((8, 0, 0, 0), (6, 8, 10, 12)): Fraction(9026399212157210195951, 215892499727278669824),
        ((8, 0, 0, 1), (6, 8, 10, 12)): Fraction(180066922568639569698725964351371737, 3422078601943995921366744570003456),
        ((8, 0, 1, 0), (6, 8, 10, 12)): Fraction(147854972046009062807952805552597, 2900931974575463122360860672000),
        ((8, 0, 1, 1), (6, 8, 10, 12)): Fraction(333509921883499861064473515483066766500344713481, 5388541849765093737620930669710241955840000000),
        ((8, 1, 0, 0), (6, 8, 10, 12)): Fraction(37526126146153426203987472683107497, 760461911543110204748165460000768),
        ((8, 1, 0, 1), (6, 8, 10, 12)): Fraction(272381964778859120956017000526023703819482388021, 4520236526927426344815683998337669335269507072),
        ((8, 1, 1, 0), (6, 8, 10, 12)): Fraction(159651764886122509082247512278941857313598919399, 2724872520572570857937695311497919882854400000),
        ((8, 1, 1, 1), (6, 8, 10, 12)): Fraction(79292098089062338896203524996913063096017328800173834654286573, 1138839239161760419136090984182788422734204258536652800000000),
        ((9, 0, 0, 0), (6, 8, 10, 12)): Fraction(51897773343582111932203623017, 1087849490465798670885322752),
        ((9, 0, 0, 1), (6, 8, 10, 12)): Fraction(24250369427929876095509111718319640118344267, 413840014061959199049287475433746582208512),
        ((9, 0, 1, 0), (6, 8, 10, 12)): Fraction(1997211531030638909421448956842376962627, 35081652667741495687636267380926054400),
        ((9, 0, 1, 1), (6, 8, 10, 12)): Fraction(147545845117269422615148651173535438655509175257842419681, 2172163465808411443969900101056649060696037785600000000),
        ((9, 1, 0, 0), (6, 8, 10, 12)): Fraction(10170150736335397849057530376489137596842691, 183928895138648532910794433526109592092672),
        ((9, 1, 0, 1), (6, 8, 10, 12)): Fraction(18113102022371452674936445186394527470336141619105812665, 273321417398822500592661836203869221456209022048796672),
        ((9, 1, 1, 0), (6, 8, 10, 12)): Fraction(766222028537434283864457634455616906400582780384503168007, 11862908741268337699334281085237379403481294359756800000),
        ((9, 1, 1, 1), (6, 8, 10, 12)): Fraction(416972075640912407067367241979990513590385584796413200513759536405639649, 5508900309668887837865331632128776075184703673330140052455424000000000),
        ((10, 0, 0, 0), (6, 8, 10, 12)): Fraction(1175926329622606650143536186624838945, 21926032917338434804772667113078784),
        ((10, 0, 0, 1), (6, 8, 10, 12)): Fraction(19394608558222793590897452023151714647559633082159033, 300279877513354798014398989970071166150620263481344),
        ((10, 0, 1, 0), (6, 8, 10, 12)): Fraction(8340260144174200224528626187925968674631206891, 132578336536157925046990972964883365520998400),
        ((10, 0, 1, 1), (6, 8, 10, 12)): Fraction(3497355231761907540296454487849454089774575863241402630552177237959, 47283270632762899914539322556647286106741269168826351616000000000),
        ((10, 1, 0, 0), (6, 8, 10, 12)): Fraction(908376385398658345614087951829922221610850401826725, 14828635926585422124167851356546724254351617949696),
        ((10, 1, 0, 1), (6, 8, 10, 12)): Fraction(28673283167950051183733288188102068152084896901275136032772135693, 396640822296159924326303877513271877413298664479770083776790528),
        ((10, 1, 1, 0), (6, 8, 10, 12)): Fraction(40511551988282098720999193135512563316256954245168409216364231203, 573843782257175816444305378346747507831739965971889588797440000),
        ((10, 1, 1, 1), (6, 8, 10, 12)): Fraction(47061812021619858669824556652479921427959080514521770800346518776965561037917197607, 575600490473863922603063320492798552212550602887969431804371858748342272000000000),
        ((11, 0, 0, 0), (6, 8, 10, 12)): Fraction(29619303722436447922271833379787089100980057, 497168762010592218926216148618312620703744),
        ((11, 0, 0, 1), (6, 8, 10, 12)): Fraction(7689665778241758667890244493470135250214471010208805723577547, 108940655537885721403098599170515347189931884164975914123264),
        ((11, 0, 1, 0), (6, 8, 10, 12)): Fraction(3976631441158165365127760759787085651788880818638251919, 57718836221634399309740383980282331673268150840852480),
        ((11, 0, 1, 1), (6, 8, 10, 12)): Fraction(18529438635259139593393460797539451541394925270520713163453175453268677229661, 231582123678838102672736490567111386503858361810075859110326173696000000000),
        ((11, 1, 0, 0), (6, 8, 10, 12)): Fraction(26042893217933606243302935691902336030601299070936855442155627, 387344553023593676099906130384054567786424477031025472438272),
        ((11, 1, 0, 1), (6, 8, 10, 12)): Fraction(9737143850741956701535405060955296720944181173882267724838308407786027475163, 124329705942354607282261677226444487277910930223801397269744321489641930752),
        ((11, 1, 1, 0), (6, 8, 10, 12)): Fraction(34451271680434606069750089665589252259148801506435999801902493379366459368037, 449687883182706189533643219134998868916055158506226118597165514647142400000),
        ((11, 1, 1, 1), (6, 8, 10, 12)): Fraction(475434364482565399316100328532439464847945181201081056377146602683380998432436387884212622142877, 5412774154707834867604883702325156639822664717849988166977961325099155236517775933440000000000),
        ((12, 0, 0, 0), (6, 8, 10, 12)): Fraction(70923365813321046283314123145046748978307097489755685, 1082228179155644987057632199630293718873777828265984),
        ((12, 0, 0, 1), (6, 8, 10, 12)): Fraction(54486598799682518488734336950591788088657891636840541764766378974837369, 711420283941390651410646499022166179339852887480553039186922005594112),
        ((12, 0, 1, 0), (6, 8, 10, 12)): Fraction(141143559679016890591325902261282884846800999028560478062911787957, 1884620147125961122011201908912039278188951512126268384686899200),
        ((12, 0, 1, 1), (6, 8, 10, 12)): Fraction(31237320003333570837733542781601003028551452016615482060068150106974896242094177379220999, 362954790833372725609272370643365455853968728040530484190595536871942856376320000000000),
        ((12, 1, 0, 0), (6, 8, 10, 12)): Fraction(185207024814575271250173457073966358002536035493491878239954625050962191, 2529494342902722316126743107634368637652810266597521917109056019890176),
        ((12, 1, 0, 1), (6, 8, 10, 12)): Fraction(3287283972445285953200936522660177796571590327165769541109824991147576038195691281420357, 38971973913896411046755162656741127806723185968519914802241321540713917702927986720768),
        ((12, 1, 1, 0), (6, 8, 10, 12)): Fraction(3882604489099525560927468945193303181749035756761990440330122918087740277778696865366119, 46985886759616622114625726582683651387349520120225591727239247613707944761439027200000),
        ((12, 1, 1, 1), (6, 8, 10, 12)): Fraction(9560267848262347771742337629394798499990737435610812287047603771832224831167799922253843886012332751042338967, 101800205297786991000446289825601102001272143909500643126892610326946833062109604368572416104857600000000000)
        }
